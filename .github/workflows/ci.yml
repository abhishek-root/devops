name: CI/CD for Dev Branch

on:
  push:
    branches:
      - dev

jobs:
  lint_and_test:
    name: Lint & Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: 3.11

      - name: Install dependencies
        run: |
          sudo apt remove man-db -y
          sudo apt install pylint python3-pytest python3-fastapi python3-httpx -y
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Pylint
        run: pylint app/main.py

      - name: Run Unit Tests
        run: pytest --maxfail=1 --disable-warnings -q

  # -------------------------------
  # Stage 2: Terraform Validation
  # -------------------------------
  terraform_validate:
    name: Stage 2 - Terraform Validate
    runs-on: ubuntu-latest
    needs: lint_and_test  # runs after stage 1 passes

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Terraform Init
        working-directory: infra
        run: terraform init 
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

      - name: Terraform Validate
        working-directory: infra
        run: terraform validate
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

  # -------------------------------
  # Stage 3: Terraform Plan
  # -------------------------------
  terraform_plan:
    name: Stage 3 - Terraform Plan
    runs-on: ubuntu-latest
    needs: terraform_validate  

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Terraform Init
        working-directory: infra
        run: terraform init 
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

      - name: Terraform Plan
        working-directory: infra
        run: terraform plan 
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
